<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>对话小说 - 增强预览版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        
        body { 
            font-family: 'Noto Sans SC', sans-serif; 
            background-color: #f1f5f9; 
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s;
        }

        /* 手机容器 */
        .phone-container {
            width: 375px;
            height: 750px;
            background: #ffffff;
            border: 12px solid #1e293b;
            border-radius: 40px;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* 黑夜模式样式 */
        .dark .phone-container {
            background: #0f172a;
            border-color: #334155;
        }
        .dark header { background: #1e293b; border-color: #334155; }
        .dark #sectionName { color: #f1f5f9; }
        .dark #tapHint { background: #1e293b; color: #64748b; border-color: #334155; }
        .dark .bubble-left { background: #334155; color: #f1f5f9; }
        .dark .narration-style { color: #94a3b8; }
        .dark #drawer { background: #1e293b; color: #f1f5f9; }
        .dark #drawer h3 { color: #f1f5f9; }
        .dark .chapter-item { background: #334155; color: #cbd5e1; }

        @media (max-width: 450px) {
            .phone-container { width: 100vw; height: 100vh; border: none; border-radius: 0; }
        }

        /* 聊天区 */
        .chat-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 15px;
            scroll-behavior: smooth;
        }
        .chat-content::-webkit-scrollbar { display: none; }

        /* 气泡基础样式 */
        .bubble-left { background: #f1f5f9; border-radius: 2px 16px 16px 16px; color: #1e293b; }
        .bubble-right { border-radius: 16px 2px 16px 16px; color: white; }
        
        .narration-style { 
            background: transparent; 
            color: #64748b;
            font-size: 0.85rem; 
            text-align: center; 
            width: 100%; 
            margin: 20px 0; 
            font-weight: 500;
        }

        .message-anim { animation: fadeInStep 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        @keyframes fadeInStep { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* 覆盖层 */
        #importOverlay {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.98);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .dark #importOverlay { background: #0f172a; color: white; }

        #drawer {
            position: absolute;
            left: -100%; top: 0; width: 80%; height: 100%;
            background: white; z-index: 200;
            box-shadow: 10px 0 30px rgba(0,0,0,0.1);
            transition: left 0.3s ease;
        }
        #drawer.open { left: 0; }
        .drawer-overlay {
            position: absolute;
            inset: 0; background: rgba(0,0,0,0.5);
            z-index: 190; display: none;
        }
        .drawer-overlay.open { display: block; }
    </style>
</head>
<body class="light">

    <div class="phone-container">
        <!-- 头部 -->
        <header class="h-16 border-b flex items-center justify-between px-4 shrink-0 bg-white z-10 transition-colors">
            <button onclick="toggleDrawer()" class="p-2 text-slate-500 hover:bg-slate-100 rounded-full transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <div class="flex flex-col items-center">
                <span id="titleText" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">请导入书籍</span>
                <span id="sectionName" class="text-sm font-bold text-slate-800 truncate max-w-[150px]">未开始阅读</span>
            </div>
            <div class="flex">
                <button onclick="toggleDarkMode()" class="p-2 text-slate-400 hover:text-indigo-500 transition">
                    <svg id="themeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
                <button onclick="restartSection()" class="p-2 text-slate-400 hover:text-indigo-500 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                </button>
            </div>
        </header>

        <!-- 聊天区域 -->
        <div id="chatContent" class="chat-content" onclick="nextStep()">
            <!-- 内容动态生成 -->
        </div>

        <!-- 底部提示 -->
        <footer id="tapHint" class="h-12 flex items-center justify-center bg-slate-50 text-[11px] font-medium text-slate-400 animate-pulse border-t uppercase tracking-wider">
            点击屏幕继续阅读
        </footer>

        <!-- 导入遮罩 -->
        <div id="importOverlay">
            <div class="w-20 h-20 bg-indigo-600 text-white rounded-3xl flex items-center justify-center mb-6 shadow-xl shadow-indigo-200">
                <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
            </div>
            <h2 class="text-xl font-bold mb-2">对话小说预览</h2>
            <p class="text-sm text-slate-500 mb-8 px-10 text-center">导入导出的 JSON 工程文件，即可模拟真实的手机阅读体验。</p>
            <label class="cursor-pointer bg-indigo-600 hover:bg-indigo-700 text-white px-10 py-4 rounded-2xl font-bold shadow-lg shadow-indigo-200 transition-all active:scale-95">
                选择工程文件
                <input type="file" class="hidden" accept=".json" onchange="handleImport(event)">
            </label>
        </div>

        <!-- 侧滑菜单 -->
        <div id="drawerOverlay" class="drawer-overlay" onclick="toggleDrawer()"></div>
        <div id="drawer">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="font-black text-slate-800 text-xl">章节目录</h3>
                <button onclick="toggleDrawer(false)" class="text-slate-400">✕</button>
            </div>
            <div id="chapterList" class="overflow-y-auto h-full pb-32 p-4 space-y-6">
                <!-- 章节列表 -->
            </div>
        </div>
    </div>

    <script>
        let novelData = null;
        let currentChapterIdx = 0;
        let currentSectionIdx = 0;
        let messageIndex = 0;

        // 切换黑夜模式
        function toggleDarkMode() {
            const body = document.body;
            body.classList.toggle('dark');
            const isDark = body.classList.contains('dark');
            const icon = document.getElementById('themeIcon');
            
            if (isDark) {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z"></path>';
            } else {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>';
            }
        }

        // 导入处理
        function handleImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const json = JSON.parse(event.target.result);
                    novelData = json.data || json;
                    if (!novelData.chapters) throw new Error();
                    document.getElementById('importOverlay').style.display = 'none';
                    renderChapterList();
                    loadSection(0, 0);
                } catch (err) {
                    alert("文件格式不正确，请上传有效的工程文件");
                }
            };
            reader.readAsText(file);
        }

        // 加载章节
        function loadSection(chapIdx, secIdx) {
            currentChapterIdx = chapIdx;
            currentSectionIdx = secIdx;
            messageIndex = 0;
            const chapter = novelData.chapters[chapIdx];
            const section = chapter.sections[secIdx];
            document.getElementById('titleText').innerText = chapter.name;
            document.getElementById('sectionName').innerText = section.name;
            document.getElementById('chatContent').innerHTML = '';
            document.getElementById('tapHint').innerText = "点击屏幕继续阅读";
            toggleDrawer(false);
            nextStep();
        }

        // 下一步阅读渲染
        function nextStep() {
            if (!novelData) return;
            const chapter = novelData.chapters[currentChapterIdx];
            const section = chapter.sections[currentSectionIdx];
            const messages = section.messages;

            if (messageIndex >= messages.length) {
                document.getElementById('tapHint').innerText = "本章已读完，请切换章节";
                return;
            }

            const msg = messages[messageIndex];
            const char = chapter.characters.find(c => c.id === msg.charId) || { name: '未知', color: '#ccc' };
            
            // 确定左右位置
            const pos = section.charPositions && section.charPositions[char.id] 
                        ? section.charPositions[char.id] 
                        : (chapter.characters.indexOf(char) % 2 === 1 ? 'right' : 'left');

            const isRight = !char.isNarrative && pos === 'right';
            
            let html = '';
            if (char.isNarrative) {
                html = `<div class="message-anim narration-style">${msg.text}</div>`;
            } else {
                html = `
                    <div class="flex ${isRight ? 'flex-row-reverse' : 'flex-row'} items-start gap-3 mb-6 message-anim">
                        <!-- 头像 -->
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-xs font-bold shrink-0 shadow-md transition-transform active:scale-90" 
                             style="background-color: ${char.color}">
                            ${char.displayChar || char.name[0]}
                        </div>
                        <!-- 名字与气泡容器 -->
                        <div class="flex flex-col ${isRight ? 'items-end' : 'items-start'} max-w-[72%]">
                            <!-- 名字：根据位置对齐，黑夜模式下自动适配颜色 -->
                            <span class="text-[11px] font-bold text-slate-400 dark:text-slate-500 mb-1.5 px-1 tracking-wide">
                                ${char.name}
                            </span>
                            <!-- 气泡 -->
                            <div class="p-3.5 text-[15px] leading-relaxed shadow-sm ${isRight ? 'bubble-right' : 'bubble-left'}" 
                                 style="${isRight ? 'background-color:' + char.color : ''}">
                                ${msg.text}
                            </div>
                        </div>
                    </div>
                `;
            }

            const container = document.getElementById('chatContent');
            container.insertAdjacentHTML('beforeend', html);
            
            // 平滑滚动到底部
            setTimeout(() => {
                container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            }, 50);

            messageIndex++;
            if (messageIndex >= messages.length) {
                document.getElementById('tapHint').innerText = "--- 本章完 ---";
            }
        }

        // 目录渲染
        function renderChapterList() {
            const list = document.getElementById('chapterList');
            list.innerHTML = novelData.chapters.map((chap, cIdx) => `
                <div>
                    <div class="text-[11px] font-black text-indigo-500 dark:text-indigo-400 uppercase mb-3 tracking-[0.2em] px-1">${chap.name}</div>
                    <div class="space-y-2">
                        ${chap.sections.map((sec, sIdx) => `
                            <div onclick="loadSection(${cIdx}, ${sIdx})" 
                                 class="chapter-item p-4 bg-slate-50 rounded-2xl text-sm font-bold text-slate-700 active:scale-[0.98] active:bg-indigo-50 transition-all border border-transparent cursor-pointer">
                                ${sec.name}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function toggleDrawer(show) {
            const drawer = document.getElementById('drawer');
            const overlay = document.getElementById('drawerOverlay');
            if (show === undefined) show = !drawer.classList.contains('open');
            show ? (drawer.classList.add('open'), overlay.classList.add('open')) 
                 : (drawer.classList.remove('open'), overlay.classList.remove('open'));
        }

        function restartSection() {
            if (novelData) loadSection(currentChapterIdx, currentSectionIdx);
        }
    </script>
</body>
</html>
